<?phpnamespace frontend\controllers;use Yii;use yii\web\Controller;use wokaextend\components\common\region\Region;use common\models\common\Uqrcode; //推广二维码绑定use wokaextend\wechat\Popularize; //生成use frontend\components\common\user\WxUserBase;use common\models\project\NewUqrcode; use wechat\components\common\WQrcode;use common\models\wechat\QrcodeM\WechatQrcode;use common\models\project\Wxuser;/** * Summary of IndexController  网站路由默认入口控制器 */class TuiguangController extends Controller{     //背景图    public $qrcodeBg='woka_qrcode/qrcode_bg.png';    //用户头像    public $uHeadimg='woka_qrcode/headimg/';    public $uResizeHeadimg='woka_qrcode/headimg-resize/';    //file    public $qrcodeFile='woka_qrcode/ticketimg/';    public $qrcodeResizeFile='woka_qrcode/ticketimg-resize/';    //    public $saveFile='woka_qrcode/userimg/';            public $headSize=[        'w'=>120,        'h'=>120        ];    public $qrcodeSize=[            'w'=>250,            'h'=>250            ];        function beforeAction($action)    {        return true;    }           public function actionIndex()   {       $CUser=new WxUserBase();       $uInfo=$CUser->getUInfo(); //用户信息               $uid=$uInfo['id'];        $wxid=1;            if(empty($uid))        {            return '请求错误';        }        $modelQrcode=NewUqrcode::findOne(["userid"=>$uid]);        if(!$modelQrcode )        {                  //查找未绑定二维码            $modelQrcode=NewUqrcode::findOne(["userid"=>0]);            if($modelQrcode)            {                //保存使用标识                $modelQrcode->userid=$uid;               $modelQrcode->save();                                  //如果未生成则去创建        if(empty($modelQrcode->yqimg))        {           $modelWxuser= Wxuser::findOne($uid);           //获取用户头像                       $uHeadimgFile=  self::getWxHeadimg($modelWxuser->headimgurl);                     //获取二维码           if(empty( $modelQrcode->qrcode))           {                               $tId=$modelQrcode->id;                               $Re=Popularize::createTicket($wxid,2,0,$tId);                              $modelQrcode->ticket=$Re['ticket'];                  $fileNmaeEnd=$this->qrcodeFile.date("Y-m-dHis",time()).uniqid().'.jpg';               $fileNmae=Yii::getAlias('@webbase')."/".$fileNmaeEnd;               $modelQrcode->qrcode=$fileNmaeEnd;               $ReQR=Popularize::getQrcode($Re['ticket'],$fileNmae);               //缩放正常比例               $fileNmae=self::resize_jpg($fileNmae,$this->qrcodeSize['w'],$this->qrcodeSize['h'],$this->qrcodeResizeFile);               $modelQrcode->qrcode=$fileNmae;               $modelQrcode->save();                        }           //推广码背景图           $bgImg = imagecreatefromstring(file_get_contents($this->qrcodeBg));             //二维码图片           $qrcodeImg = imagecreatefromstring(file_get_contents($modelQrcode->qrcode));           //用户头像           $headImg=imagecreatefromstring(file_get_contents($uHeadimgFile));                      //获取二维码大小          // list($qCodeWidth, $qCodeHight, $qCodeType) = getimagesize($qrcodeImg);           // imagecopymerge使用注解           imagecopymerge($bgImg, $qrcodeImg,625 ,1350, 0, 0, $this->qrcodeSize['w'],$this->qrcodeSize['h'], 100);                      //获取头像大小                 imagecopymerge($bgImg, $headImg,105 ,920, 0, 0, $this->headSize['w'],$this->headSize['h'], 100);                      //添加字体           $black = imagecolorallocate($bgImg,0,0,0);//字体颜色 RGB                      $font =   Yii::getAlias('@webbase')."/woka_qrcode/fonts/" .'msyh.ttc';//字体           $sname=$modelWxuser->nickname;                   imagefttext($bgImg, 30,0, 240, 970, $black, $font, $sname);                              $sname=  mb_substr($modelWxuser->nickname,0,3,"utf-8").'...';                          imagefttext($bgImg, 30,0, 264, 1160, $black, $font, $sname);                                 //转存           $fileTgEnd=$this->saveFile.date("Y-m-dHis",time()).uniqid().'.png';           $fileTg=Yii::getAlias('@webbase')."/".$fileTgEnd;           imagepng($bgImg,$fileTg);                         $modelQrcode->yqimg= $fileTgEnd;			  $modelQrcode->save();        }                    }                    }                return  $this->render("index",[            'modelQr'=>$modelQrcode            ]);    }     /**     * Summary of getWxHeadimg     * 返回用户头像     * @param mixed $uid      */    public  function  getWxHeadimg($imgUrl)    {               //获取微信头像        $fileHeadEnd= $this->uHeadimg.date("Y-m-dHis",time()).uniqid().'.jpg';        $filehend=Yii::getAlias('@webbase').'/'.$fileHeadEnd;        $himg=  self::GrabImage($imgUrl,$filehend);        //处理头像大小        $fileHeadEnd=  self::resize_jpg($filehend,$this->headSize['w'],$this->headSize['h'],$this->uResizeHeadimg );                    return $fileHeadEnd;    }                public function GrabImage($url, $filename = "") {        //去除URL连接上面可能的引号        $url = preg_replace( '/(?:^[\'"]+|[\'"\/]+$)/', '', $url );        $hander = curl_init();        $fp = fopen($filename,'wb');        curl_setopt($hander,CURLOPT_URL,$url);        curl_setopt($hander,CURLOPT_FILE,$fp);        curl_setopt($hander,CURLOPT_HEADER,0);        curl_setopt($hander,CURLOPT_FOLLOWLOCATION,1);                curl_setopt($hander,CURLOPT_TIMEOUT,60);                curl_exec($hander);        curl_close($hander);        fclose($fp);        return $filename;     }     /**     * Summary of resize_jpg     * 重置图片大小     * @param mixed $img      * @param mixed $w      * @param mixed $h      * @return mixed     */    public  function resize_jpg($img,$w,$h,$file='upload/'){         // $thumb = imagecreate ($w, $h);         $image = imagecreatefromjpeg($img);         $imagedata = getimagesize($img);         if ($h = "auto") $h = $w/($imagedata[0]/$imagedata[1]);//根据原图的纵横比得出高度！         $thumb = imagecreatetruecolor ($w, $h);         imagecopyresized ($thumb, $image, 0, 0, 0, 0, $w, $h, $imagedata[0], $imagedata[1]);         $fileNmaeEnd=date("Y-m-dHis",time()).uniqid().'.jpg';        $fileNmae=Yii::getAlias('@webbase')."/".$file.$fileNmaeEnd;        imagejpeg($thumb,$fileNmae);         return $file.$fileNmaeEnd;    } }